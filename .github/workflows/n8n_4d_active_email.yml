name: Trigger 4D Active Email Workflow

# This workflow triggers 4D Active Email workflow every 24 hours (once per day)
on:
  schedule:
    # Run once daily at 9:00 AM UTC (2:30 PM IST)
    - cron: '0 9 * * *'
  
  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:

jobs:
  trigger-4d-active-email:
    name: Trigger 4D Active Email
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Trigger 4D Active Email Workflow
      env:
        N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
        ACTIVE_EMAIL_WEBHOOK_PATH: ${{ secrets.ACTIVE_EMAIL_WEBHOOK_PATH }}
      run: |
        if [ -z "$N8N_BASE_URL" ]; then
          echo "ERROR: N8N_BASE_URL secret is not set"
          echo "Please add your n8n base URL (e.g., https://abc123.ngrok.io) as a GitHub secret"
          exit 1
        fi
        
        if [ -z "$ACTIVE_EMAIL_WEBHOOK_PATH" ]; then
          echo "ERROR: ACTIVE_EMAIL_WEBHOOK_PATH secret is not set"
          echo "Please add the webhook path for 4D Active Email workflow as a GitHub secret"
          exit 1
        fi
        
        # Remove trailing slash from base URL if present
        base_url=$(echo "$N8N_BASE_URL" | sed 's:/*$::')
        webhook_url="${base_url}/webhook/${ACTIVE_EMAIL_WEBHOOK_PATH}"
        
        echo "Triggering 4D Active Email workflow..."
        echo "Webhook URL: $webhook_url"
        
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST "$webhook_url" \
          -H "Content-Type: application/json" \
          -d '{"triggered_by": "github_actions", "workflow": "4D Active eMail", "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}')
        
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        body=$(echo "$response" | sed '/HTTP_STATUS:/d')
        
        echo "Response Status: $http_status"
        echo "Response Body: $body"
        
        if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 300 ]; then
          echo "✅ 4D Active Email workflow triggered successfully!"
          exit 0
        else
          echo "❌ Failed to trigger 4D Active Email workflow. HTTP Status: $http_status"
          exit 1
        fi

